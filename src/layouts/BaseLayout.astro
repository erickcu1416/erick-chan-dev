---
import Head from '@components/seo/Head.astro';
import JsonLd from '@components/seo/JsonLd.astro';
import Header from '@components/common/Header.astro';
import Footer from '@components/common/Footer.astro';
import WhatsAppButton from '@components/common/WhatsAppButton.astro';
import '@assets/styles/global.css';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  canonical?: string;
  type?: 'website' | 'article' | 'profile';
  noindex?: boolean;
  jsonLdType?: 'person' | 'organization' | 'website';
}

const {
  title,
  description,
  image,
  canonical,
  type = 'website',
  noindex = false,
  jsonLdType = 'person',
} = Astro.props;
---

<!doctype html>
<html lang={Astro.currentLocale || 'es'}>
  <Head
    title={title}
    description={description}
    image={image}
    canonical={canonical}
    type={type}
    noindex={noindex}
  />
  <body class="dark-version">
    <div class="page-wrapper">
      <!-- Preloader -->
      <div class="preloader">
        <div class="custom-loader"></div>
      </div>

      <Header />

      <main>
        <slot />
      </main>

      <Footer />
    </div>

    <WhatsAppButton />

    <JsonLd type={jsonLdType} />

    <script>
      // Preloader
      window.addEventListener('load', () => {
        const preloader = document.querySelector('.preloader');
        if (preloader) {
          setTimeout(() => {
            preloader.classList.add('fade-out');
            setTimeout(() => {
              (preloader as HTMLElement).style.display = 'none';
            }, 500);
          }, 200);
        }
      });

      // Header scroll
      const header = document.querySelector('.main-header');
      const scrollTop = document.querySelector('.scroll-top');

      function handleScroll() {
        const scrollY = window.scrollY;

        if (header) {
          if (scrollY >= 100) {
            header.classList.add('fixed-header');
          } else {
            header.classList.remove('fixed-header');
          }
        }

        if (scrollTop) {
          if (scrollY >= 250) {
            scrollTop.classList.add('show');
          } else {
            scrollTop.classList.remove('show');
          }
        }
      }

      window.addEventListener('scroll', handleScroll, { passive: true });
      handleScroll();

      // Scroll to top
      scrollTop?.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // Mobile menu toggle
      const navbarToggle = document.querySelector('.navbar-toggle');
      const navbarCollapse = document.querySelector('.navbar-collapse');

      navbarToggle?.addEventListener('click', () => {
        navbarCollapse?.classList.toggle('show');
      });

      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (!target.closest('.main-menu') && navbarCollapse?.classList.contains('show')) {
          navbarCollapse?.classList.remove('show');
        }
      });

      // Counter Animation with Intersection Observer
      function initCounterAnimation() {
        const counterItems = document.querySelectorAll('.counter-text-wrap');
        if (!counterItems.length) return;

        function easeOutQuad(t: number): number {
          return t * (2 - t);
        }

        const animateCounter = (element: Element) => {
          const countText = element.querySelector('.count-text') as HTMLElement | null;
          if (!countText || element.classList.contains('counted')) return;

          const target = parseInt(countText.getAttribute('data-stop') || countText.textContent || '0', 10);
          const duration = parseInt(countText.getAttribute('data-speed') || '2000', 10);
          const startTime = performance.now();

          element.classList.add('counted');

          function updateCounter(currentTime: number) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const currentValue = Math.floor(target * easeOutQuad(progress));

            if (countText) {
              countText.textContent = currentValue.toString();
            }

            if (progress < 1) {
              requestAnimationFrame(updateCounter);
            } else if (countText) {
              countText.textContent = target.toString();
            }
          }

          requestAnimationFrame(updateCounter);
        };

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                animateCounter(entry.target);
                observer.unobserve(entry.target);
              }
            });
          },
          { threshold: 0.5 }
        );

        counterItems.forEach((item) => observer.observe(item));
      }

      // AOS-like animations
      function initScrollAnimations() {
        const animatedElements = document.querySelectorAll('[data-aos]');
        if (!animatedElements.length) return;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                const element = entry.target as HTMLElement;
                const delay = element.getAttribute('data-aos-delay') || '0';
                setTimeout(() => {
                  element.classList.add('aos-animate');
                }, parseInt(delay, 10));
                observer.unobserve(element);
              }
            });
          },
          { threshold: 0.1, rootMargin: '0px 0px -50px 0px' }
        );

        animatedElements.forEach((element) => {
          element.classList.add('aos-init');
          observer.observe(element);
        });
      }

      // Initialize on DOM ready
      document.addEventListener('DOMContentLoaded', () => {
        initCounterAnimation();
        initScrollAnimations();
      });
    </script>
  </body>
</html>
